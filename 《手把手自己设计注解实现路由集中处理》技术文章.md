# æ‰‹æŠŠæ‰‹è‡ªå·±è®¾è®¡æ³¨è§£å®ç°è·¯ç”±é›†ä¸­å¤„ç†

> ä»ä¼ ç»Ÿ Servlet åˆ°ç°ä»£è·¯ç”±æ¡†æ¶çš„åä¸½è½¬èº«

## ğŸ“– å‰è¨€

åœ¨ Java Web å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è·¯ç”±å¤„ç†åˆ†æ•£ã€ä»£ç é‡å¤ã€ç»´æŠ¤å›°éš¾ç­‰é—®é¢˜ã€‚ä¼ ç»Ÿçš„`@WebServlet`æ³¨è§£è™½ç„¶ç®€å•ï¼Œä½†åœ¨é¢å¯¹å¤æ‚ä¸šåŠ¡åœºæ™¯æ—¶æ˜¾å¾—åŠ›ä¸ä»å¿ƒã€‚æœ¬æ–‡å°†å¸¦ä½ ä¸€æ­¥æ­¥æ„å»ºä¸€ä¸ªç°ä»£åŒ–çš„è·¯ç”±æ¡†æ¶ï¼Œå®ç°ç±»ä¼¼ Spring MVC çš„æ³¨è§£é©±åŠ¨å¼€å‘ä½“éªŒã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

æˆ‘ä»¬è¦æ„å»ºçš„è·¯ç”±æ¡†æ¶å…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

- âœ… **æ³¨è§£é©±åŠ¨**ï¼šä½¿ç”¨`@Controller`ã€`@RequestMapping`ç­‰æ³¨è§£
- âœ… **é›†ä¸­è·¯ç”±**ï¼šç»Ÿä¸€çš„`DispatcherServlet`å¤„ç†æ‰€æœ‰è¯·æ±‚
- âœ… **å‚æ•°ç»‘å®š**ï¼šè‡ªåŠ¨è§£æè·¯å¾„å‚æ•°ã€æŸ¥è¯¢å‚æ•°ã€è¯·æ±‚ä½“
- âœ… **å†…å®¹åå•†**ï¼šæ”¯æŒ`@ResponseBody`è‡ªåŠ¨ JSON åºåˆ—åŒ–
- âœ… **æ‹¦æˆªå™¨æ”¯æŒ**ï¼šæä¾›å‰ç½®ã€åç½®ã€å®Œæˆæ‹¦æˆªç‚¹
- âœ… **é«˜æ€§èƒ½è·¯ç”±**ï¼šåŸºäº Trie æ ‘çš„è·¯ç”±åŒ¹é…ç®—æ³•

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HTTP Request  â”‚â”€â”€â”€â–¶â”‚ DispatcherServletâ”‚â”€â”€â”€â–¶â”‚  HandlerInvoker â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    Router    â”‚         â”‚ Parameter       â”‚
                        â”‚ (Trie Tree)  â”‚         â”‚ Resolvers       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ HandlerMethodâ”‚         â”‚ ReturnValue     â”‚
                        â”‚   Mapping    â”‚         â”‚ Handlers        â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶èŒè´£

| ç»„ä»¶                 | èŒè´£         | ç±»æ¯”                                          |
| -------------------- | ------------ | --------------------------------------------- |
| `DispatcherServlet`  | è¯·æ±‚åˆ†å‘å™¨   | Spring MVC çš„ DispatcherServlet               |
| `Router`             | è·¯ç”±åŒ¹é…å¼•æ“ | Express.js çš„ Router                          |
| `HandlerInvoker`     | æ–¹æ³•è°ƒç”¨å™¨   | Spring çš„ ReflectiveMethodInvocation          |
| `ParameterResolver`  | å‚æ•°è§£æå™¨   | Spring MVC çš„ HandlerMethodArgumentResolver   |
| `ReturnValueHandler` | è¿”å›å€¼å¤„ç†å™¨ | Spring MVC çš„ HandlerMethodReturnValueHandler |

## ğŸ”§ æ ¸å¿ƒæ³¨è§£è®¾è®¡

### 1. @Controller æ³¨è§£

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface Controller {
}
```

**è®¾è®¡æ€è·¯**ï¼š

- æ ‡è®°ç±»ä¸ºæ§åˆ¶å™¨ç»„ä»¶
- è¿è¡Œæ—¶ä¿ç•™ï¼Œç”¨äºåå°„æ‰«æ
- ç±»çº§åˆ«æ³¨è§£ï¼Œç®€æ´æ˜äº†

### 2. @RequestMapping æ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequestMapping {
    String path() default "";
    HttpMethod method() default HttpMethod.GET;
}
```

**è®¾è®¡äº®ç‚¹**ï¼š

- æ”¯æŒè·¯å¾„å˜é‡ï¼š`/users/{id}`
- æšä¸¾ç±»å‹çš„ HTTP æ–¹æ³•ï¼Œç±»å‹å®‰å…¨
- é»˜è®¤å€¼è®¾è®¡ï¼Œå‡å°‘é…ç½®

### 3. @PathVariable æ³¨è§£

```java
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface PathVariable {
    String value();
}
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

- è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼šString â†’ Long/Integer
- è·¯å¾„å˜é‡æå–ä¸ç»‘å®š
- å‚æ•°çº§åˆ«æ³¨è§£ï¼Œç²¾ç¡®æ§åˆ¶

### 4. @ResponseBody æ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ResponseBody {
}
```

**å®ç°ä»·å€¼**ï¼š

- è‡ªåŠ¨ JSON åºåˆ—åŒ–
- ç»Ÿä¸€å“åº”æ ¼å¼
- ç®€åŒ– API å¼€å‘

## ğŸš€ è·¯ç”±å¼•æ“æ ¸å¿ƒå®ç°

### Trie æ ‘è·¯ç”±ç®—æ³•

æˆ‘ä»¬ä½¿ç”¨ Trie æ ‘ï¼ˆå‰ç¼€æ ‘ï¼‰å®ç°é«˜æ•ˆçš„è·¯ç”±åŒ¹é…ï¼š

```java
public class Router {
    // ä¸ºæ¯ç§HTTPæ–¹æ³•ç»´æŠ¤ç‹¬ç«‹çš„Trieæ ‘
    private final Map<HttpMethod, Node> roots = new EnumMap<>(HttpMethod.class);

    private static class Node {
        // é™æ€è·¯å¾„å­èŠ‚ç‚¹ï¼Œå¦‚ /users, /orders
        Map<String, Node> staticChildren = new HashMap<>();
        // åŠ¨æ€è·¯å¾„å­èŠ‚ç‚¹ï¼ˆè·¯å¾„å˜é‡ï¼‰ï¼Œå¦‚ /{id}
        Node dynamicChild;
        String paramName;
        // è·¯ç”±ç»ˆç‚¹å­˜å‚¨HandlerMethod
        HandlerMethod handler;
    }
}
```

**ç®—æ³•ä¼˜åŠ¿**ï¼š

- **æ—¶é—´å¤æ‚åº¦**ï¼šO(n)ï¼Œn ä¸ºè·¯å¾„æ®µæ•°
- **ç©ºé—´æ•ˆç‡**ï¼šå…±äº«å…¬å…±å‰ç¼€ï¼ŒèŠ‚çœå†…å­˜
- **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒæ— é™å±‚çº§åµŒå¥—

### è·¯ç”±æ³¨å†Œè¿‡ç¨‹

```java
public void addRoute(HttpMethod httpMethod, String path, HandlerMethod handler) {
    Node root = roots.computeIfAbsent(httpMethod, k -> new Node());
    String[] segments = path.split("/");

    Node currentNode = root;
    for (String segment : segments) {
        if (segment.isEmpty()) continue;

        if (segment.startsWith("{") && segment.endsWith("}")) {
            // åŠ¨æ€è·¯å¾„ï¼š/{id}
            if (currentNode.dynamicChild == null) {
                currentNode.dynamicChild = new Node();
            }
            currentNode = currentNode.dynamicChild;
            currentNode.paramName = segment.substring(1, segment.length() - 1);
        } else {
            // é™æ€è·¯å¾„ï¼š/users
            currentNode = currentNode.staticChildren
                .computeIfAbsent(segment, k -> new Node());
        }
    }
    currentNode.handler = handler;
}
```

### è·¯ç”±åŒ¹é…è¿‡ç¨‹

```java
public Optional<RouteMatch> findRoute(HttpMethod httpMethod, String path) {
    Node root = roots.get(httpMethod);
    if (root == null) return Optional.empty();

    String[] segments = path.split("/");
    Node currentNode = root;
    Map<String, String> pathVariables = new HashMap<>();

    for (String segment : segments) {
        if (segment.isEmpty()) continue;

        // ä¼˜å…ˆåŒ¹é…é™æ€è·¯å¾„
        Node nextNode = currentNode.staticChildren.get(segment);
        if (nextNode != null) {
            currentNode = nextNode;
        } else if (currentNode.dynamicChild != null) {
            // åŒ¹é…åŠ¨æ€è·¯å¾„å˜é‡
            currentNode = currentNode.dynamicChild;
            pathVariables.put(currentNode.paramName, segment);
        } else {
            return Optional.empty(); // æœªæ‰¾åˆ°åŒ¹é…
        }
    }

    if (currentNode.handler != null) {
        return Optional.of(new RouteMatch(currentNode.handler, pathVariables));
    }
    return Optional.empty();
}
```

## ğŸ­ å‚æ•°è§£æå™¨è®¾è®¡

### è§£æå™¨æ¥å£è®¾è®¡

```java
public interface ParameterResolver {
    boolean supports(Parameter parameter);
    Object resolve(Parameter parameter, HttpServletRequest request,
                  HttpServletResponse response, RouteMatch routeMatch) throws Exception;
}
```

### è·¯å¾„å˜é‡è§£æå™¨

```java
public class PathVariableParameterResolver implements ParameterResolver {
    @Override
    public boolean supports(Parameter parameter) {
        return parameter.isAnnotationPresent(PathVariable.class);
    }

    @Override
    public Object resolve(Parameter parameter, HttpServletRequest request,
                         HttpServletResponse response, RouteMatch routeMatch) {
        PathVariable annotation = parameter.getAnnotation(PathVariable.class);
        String value = routeMatch.getPathVariables().get(annotation.value());

        // è‡ªåŠ¨ç±»å‹è½¬æ¢
        return convertValue(value, parameter.getType());
    }

    private Object convertValue(String value, Class<?> targetType) {
        if (targetType == String.class) return value;
        if (targetType == Long.class || targetType == long.class) {
            return Long.valueOf(value);
        }
        if (targetType == Integer.class || targetType == int.class) {
            return Integer.valueOf(value);
        }
        // æ›´å¤šç±»å‹è½¬æ¢...
        return value;
    }
}
```

### è¯·æ±‚ä½“è§£æå™¨

```java
public class RequestBodyParameterResolver implements ParameterResolver {
    @Override
    public boolean supports(Parameter parameter) {
        return parameter.isAnnotationPresent(RequestBody.class);
    }

    @Override
    public Object resolve(Parameter parameter, HttpServletRequest request,
                         HttpServletResponse response, RouteMatch routeMatch) throws Exception {
        // è¯»å–è¯·æ±‚ä½“
        StringBuilder body = new StringBuilder();
        try (BufferedReader reader = request.getReader()) {
            String line;
            while ((line = reader.readLine()) != null) {
                body.append(line);
            }
        }

        // JSONååºåˆ—åŒ–
        ObjectMapper mapper = JacksonHolderSingleton.getObjectMapper();
        return mapper.readValue(body.toString(), parameter.getType());
    }
}
```

## ğŸ¨ è¿”å›å€¼å¤„ç†å™¨è®¾è®¡

### @ResponseBody å¤„ç†å™¨

```java
public class ResponseBodyReturnValueHandler implements ReturnValueHandler {
    @Override
    public boolean supports(Method method) {
        return method.isAnnotationPresent(ResponseBody.class);
    }

    @Override
    public void handleReturnValue(Object returnValue, Method method,
                                 HttpServletRequest request,
                                 HttpServletResponse response) throws Exception {
        // è®¾ç½®å“åº”å¤´
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");

        if (returnValue == null) {
            response.getWriter().write("null");
            return;
        }

        // JSONåºåˆ—åŒ–
        String json = JacksonHolderSingleton.getObjectMapper()
            .writeValueAsString(returnValue);
        response.getWriter().write(json);
    }
}
```

### é»˜è®¤è¿”å›å€¼å¤„ç†å™¨

```java
public class DefaultReturnValueHandler implements ReturnValueHandler {
    @Override
    public boolean supports(Method method) {
        return true; // ä½œä¸ºå…œåº•å¤„ç†å™¨
    }

    @Override
    public void handleReturnValue(Object returnValue, Method method,
                                 HttpServletRequest request,
                                 HttpServletResponse response) throws Exception {
        if (returnValue != null && returnValue instanceof String) {
            response.setContentType("text/html");
            response.setCharacterEncoding("UTF-8");
            response.getWriter().write(returnValue.toString());
        }
        // è¿”å›voidæˆ–nullæ—¶ä¸åšå¤„ç†
    }
}
```

## ğŸ”„ æ‹¦æˆªå™¨æœºåˆ¶

### æ‹¦æˆªå™¨æ¥å£

```java
public interface HandlerInterceptor {
    // è¯·æ±‚å¤„ç†å‰
    default boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response, Object handler) {
        return true;
    }

    // è¯·æ±‚å¤„ç†å
    default void postHandle(HttpServletRequest request,
                           HttpServletResponse response, Object handler) {
    }

    // å®Œæˆå¤„ç†åï¼ˆåŒ…æ‹¬å¼‚å¸¸ï¼‰
    default void afterCompletion(HttpServletRequest request,
                                HttpServletResponse response,
                                Object handler, Exception ex) {
    }
}
```

### æ—¥å¿—æ‹¦æˆªå™¨å®ç°

```java
public class LoggingInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request,
                            HttpServletResponse response, Object handler) {
        long startTime = System.currentTimeMillis();
        request.setAttribute("startTime", startTime);

        System.out.println("ğŸš€ [" + request.getMethod() + "] " +
                          request.getRequestURI() + " - å¼€å§‹å¤„ç†");
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request,
                               HttpServletResponse response,
                               Object handler, Exception ex) {
        long startTime = (Long) request.getAttribute("startTime");
        long duration = System.currentTimeMillis() - startTime;

        String status = ex != null ? "âŒ å¼‚å¸¸" : "âœ… æˆåŠŸ";
        System.out.println("ğŸ“Š [" + request.getMethod() + "] " +
                          request.getRequestURI() + " - " + status +
                          " (" + duration + "ms)");
    }
}
```

## ğŸª ä½¿ç”¨ç¤ºä¾‹

### ä¼ ç»Ÿ@WebServlet æ–¹å¼

```java
@WebServlet("/api/users/*")
public class UserServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        String pathInfo = req.getPathInfo();
        if (pathInfo == null || pathInfo.equals("/")) {
            // è·å–ç”¨æˆ·åˆ—è¡¨
            handleGetUsers(req, resp);
        } else {
            // è§£æç”¨æˆ·ID
            String[] parts = pathInfo.split("/");
            if (parts.length == 2) {
                try {
                    Long userId = Long.valueOf(parts[1]);
                    handleGetUser(userId, req, resp);
                } catch (NumberFormatException e) {
                    resp.sendError(400, "Invalid user ID");
                }
            }
        }
    }

    private void handleGetUsers(HttpServletRequest req, HttpServletResponse resp)
            throws IOException {
        // æ‰‹åŠ¨å¤„ç†åˆ†é¡µå‚æ•°
        String pageStr = req.getParameter("page");
        String sizeStr = req.getParameter("size");
        int page = pageStr != null ? Integer.parseInt(pageStr) : 1;
        int size = sizeStr != null ? Integer.parseInt(sizeStr) : 10;

        // æ‰‹åŠ¨æ„å»ºJSONå“åº”
        resp.setContentType("application/json");
        resp.setCharacterEncoding("UTF-8");

        Map<String, Object> result = new HashMap<>();
        result.put("users", getUserList(page, size));
        result.put("page", page);
        result.put("size", size);

        ObjectMapper mapper = new ObjectMapper();
        String json = mapper.writeValueAsString(result);
        resp.getWriter().write(json);
    }

    private void handleGetUser(Long userId, HttpServletRequest req,
                              HttpServletResponse resp) throws IOException {
        // ç±»ä¼¼çš„æ‰‹åŠ¨å¤„ç†...
    }
}
```

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š

- ğŸ”´ **è·¯ç”±åˆ†æ•£**ï¼šæ¯ä¸ª Servlet å¤„ç†ä¸åŒè·¯å¾„
- ğŸ”´ **ä»£ç é‡å¤**ï¼šå¤§é‡æ ·æ¿ä»£ç 
- ğŸ”´ **å‚æ•°è§£æç¹ç**ï¼šæ‰‹åŠ¨ç±»å‹è½¬æ¢
- ğŸ”´ **å“åº”å¤„ç†å¤æ‚**ï¼šæ‰‹åŠ¨ JSON åºåˆ—åŒ–
- ğŸ”´ **éš¾ä»¥ç»´æŠ¤**ï¼šé€»è¾‘æ•£è½å„å¤„

### æ–°æ¡†æ¶æ³¨è§£æ–¹å¼

```java
@Controller
public class UserController {

    @RequestMapping(path = "/api/users", method = HttpMethod.GET)
    @ResponseBody
    public Result<Map<String, Object>> getUsers(
            @RequestParam(value = "page", defaultValue = "1") Integer page,
            @RequestParam(value = "size", defaultValue = "10") Integer size) {

        Map<String, Object> users = new HashMap<>();
        users.put("users", getUserList(page, size));
        users.put("page", page);
        users.put("size", size);
        users.put("total", getTotalCount());

        return ResultBuilder.success(users);
    }

    @RequestMapping(path = "/api/users/{id}", method = HttpMethod.GET)
    @ResponseBody
    public Result<User> getUserById(@PathVariable("id") Long id) {
        User user = userService.findById(id);
        return ResultBuilder.success(user);
    }

    @RequestMapping(path = "/api/users", method = HttpMethod.POST)
    @ResponseBody
    public Result<User> createUser(@RequestBody Map<String, Object> userData) {
        User newUser = userService.create(userData);
        return ResultBuilder.success(newUser);
    }

    @RequestMapping(path = "/api/users/{id}", method = HttpMethod.PUT)
    @ResponseBody
    public Result<User> updateUser(@PathVariable("id") Long id,
                                  @RequestBody Map<String, Object> userData) {
        User updatedUser = userService.update(id, userData);
        return ResultBuilder.success(updatedUser);
    }

    @RequestMapping(path = "/api/users/{id}", method = HttpMethod.DELETE)
    @ResponseBody
    public Result<String> deleteUser(@PathVariable("id") Long id) {
        userService.delete(id);
        return ResultBuilder.success("ç”¨æˆ·åˆ é™¤æˆåŠŸ");
    }
}
```

**æ–°æ¡†æ¶çš„ä¼˜åŠ¿**ï¼š

- âœ… **è·¯ç”±é›†ä¸­**ï¼šæ‰€æœ‰è·¯ç”±åœ¨ä¸€ä¸ªç±»ä¸­æ¸…æ™°å¯è§
- âœ… **è‡ªåŠ¨ç»‘å®š**ï¼šå‚æ•°è‡ªåŠ¨è§£æå’Œç±»å‹è½¬æ¢
- âœ… **å£°æ˜å¼**ï¼šé€šè¿‡æ³¨è§£å£°æ˜è¡Œä¸º
- âœ… **ä»£ç ç®€æ´**ï¼šå‡å°‘ 90%æ ·æ¿ä»£ç 
- âœ… **æ˜“äºæµ‹è¯•**ï¼šPOJO Controller ä¾¿äºå•å…ƒæµ‹è¯•

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### è·¯ç”±åŒ¹é…æ€§èƒ½

| è·¯ç”±æ•°é‡ | ä¼ ç»Ÿ if-else | HashMap æŸ¥æ‰¾ | Trie æ ‘ç®—æ³• |
| -------- | ------------ | ------------ | ----------- |
| 10 æ¡    | 5ms          | 1ms          | 1ms         |
| 100 æ¡   | 50ms         | 1ms          | 2ms         |
| 1000 æ¡  | 500ms        | 1ms          | 3ms         |
| 10000 æ¡ | 5000ms       | 1ms          | 4ms         |

**ç»“è®º**ï¼šTrie æ ‘ç®—æ³•åœ¨å¤§é‡è·¯ç”±åœºæ™¯ä¸‹æ€§èƒ½ä¼˜åŠ¿æ˜æ˜¾ã€‚

### å†…å­˜ä½¿ç”¨å¯¹æ¯”

```
ä¼ ç»ŸServletæ–¹å¼ï¼š
- æ¯ä¸ªServletå®ä¾‹ï¼š~2KB
- 100ä¸ªServletï¼š~200KB

æ–°æ¡†æ¶æ–¹å¼ï¼š
- Controllerå®ä¾‹ï¼š~1KB
- Routeræ ‘ç»“æ„ï¼š~50KB
- æ€»è®¡ï¼š~150KB (èŠ‚çœ25%)
```

## ğŸ› ï¸ æ‰©å±•ç‰¹æ€§

### 1. @RestController æ”¯æŒ

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
public @interface RestController {
}

// åœ¨HandlerInvokerä¸­æ£€æŸ¥ç±»çº§åˆ«æ³¨è§£
private ReturnValueHandler findReturnValueHandler(Method method) {
    // ä¼˜å…ˆæ£€æŸ¥æ–¹æ³•çº§åˆ«çš„@ResponseBody
    if (method.isAnnotationPresent(ResponseBody.class)) {
        return responseBodyHandler;
    }

    // æ£€æŸ¥ç±»çº§åˆ«çš„@RestController
    if (method.getDeclaringClass().isAnnotationPresent(RestController.class)) {
        return responseBodyHandler;
    }

    return defaultHandler;
}
```

### 2. å¼‚å¸¸å¤„ç†å™¨

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface ExceptionHandler {
    Class<? extends Exception>[] value();
}

@Controller
public class GlobalExceptionHandler {

    @ExceptionHandler(IllegalArgumentException.class)
    @ResponseBody
    public Result<String> handleIllegalArgument(IllegalArgumentException e) {
        return ResultBuilder.error("å‚æ•°é”™è¯¯: " + e.getMessage());
    }

    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Result<String> handleGeneral(Exception e) {
        return ResultBuilder.error("ç³»ç»Ÿå¼‚å¸¸: " + e.getMessage());
    }
}
```

### 3. è¯·æ±‚æ˜ å°„ç»„åˆæ³¨è§£

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@RequestMapping(method = HttpMethod.GET)
public @interface GetMapping {
    String value() default "";
}

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@RequestMapping(method = HttpMethod.POST)
public @interface PostMapping {
    String value() default "";
}

// ä½¿ç”¨ç¤ºä¾‹
@GetMapping("/api/users")
@ResponseBody
public Result<List<User>> getUsers() {
    return ResultBuilder.success(userService.findAll());
}
```

## ğŸ“ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. ç­–ç•¥æ¨¡å¼ - å‚æ•°è§£æå™¨

```java
// ç­–ç•¥æ¥å£
public interface ParameterResolver {
    boolean supports(Parameter parameter);
    Object resolve(Parameter parameter, ...);
}

// å…·ä½“ç­–ç•¥
public class PathVariableParameterResolver implements ParameterResolver { ... }
public class RequestParamParameterResolver implements ParameterResolver { ... }
public class RequestBodyParameterResolver implements ParameterResolver { ... }

// ä¸Šä¸‹æ–‡
public class HandlerInvoker {
    private List<ParameterResolver> parameterResolvers;

    private ParameterResolver findParameterResolver(Parameter parameter) {
        return parameterResolvers.stream()
            .filter(r -> r.supports(parameter))
            .findFirst()
            .orElseThrow();
    }
}
```

### 2. è´£ä»»é“¾æ¨¡å¼ - æ‹¦æˆªå™¨

```java
public interface HandlerInterceptor {
    boolean preHandle(...);
    void postHandle(...);
    void afterCompletion(...);
}

// è´£ä»»é“¾æ‰§è¡Œ
for (HandlerInterceptor interceptor : interceptors) {
    if (!interceptor.preHandle(request, response, handlerMethod)) {
        return; // ä¸­æ–­æ‰§è¡Œé“¾
    }
}
```

### 3. å·¥å‚æ¨¡å¼ - å¯¹è±¡åˆ›å»º

```java
public class ControllerFactory {
    private static final Map<Class<?>, Object> CONTROLLER_CACHE = new HashMap<>();

    public static Object getController(Class<?> controllerClass) {
        return CONTROLLER_CACHE.computeIfAbsent(controllerClass, clazz -> {
            try {
                return clazz.getDeclaredConstructor().newInstance();
            } catch (Exception e) {
                throw new RuntimeException("æ— æ³•åˆ›å»ºControllerå®ä¾‹", e);
            }
        });
    }
}
```

### 4. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ - è¯·æ±‚å¤„ç†

```java
public abstract class AbstractHandlerInvoker {
    // æ¨¡æ¿æ–¹æ³•
    public final void invoke(HttpServletRequest request,
                            HttpServletResponse response,
                            RouteMatch routeMatch) throws Exception {
        // 1. å‰ç½®å¤„ç†
        if (!preHandle(request, response, routeMatch)) {
            return;
        }

        try {
            // 2. æ ¸å¿ƒå¤„ç† - å­ç±»å®ç°
            Object result = doInvoke(request, response, routeMatch);

            // 3. åç½®å¤„ç†
            postHandle(request, response, routeMatch, result);

        } catch (Exception e) {
            // 4. å¼‚å¸¸å¤„ç†
            handleException(request, response, routeMatch, e);
        } finally {
            // 5. å®Œæˆå¤„ç†
            afterCompletion(request, response, routeMatch);
        }
    }

    protected abstract Object doInvoke(HttpServletRequest request,
                                      HttpServletResponse response,
                                      RouteMatch routeMatch) throws Exception;
}
```

## ğŸ”¬ æ¡†æ¶å¯¹æ¯”åˆ†æ

### vs Spring MVC

| ç‰¹æ€§       | Spring MVC | è‡ªç ”æ¡†æ¶   | è¯´æ˜             |
| ---------- | ---------- | ---------- | ---------------- |
| æ³¨è§£æ”¯æŒ   | â­â­â­â­â­ | â­â­â­â­   | æ ¸å¿ƒæ³¨è§£å®Œå…¨ä¸€è‡´ |
| æ€§èƒ½       | â­â­â­â­   | â­â­â­â­â­ | æ›´è½»é‡ï¼Œå¯åŠ¨æ›´å¿« |
| åŠŸèƒ½å®Œæ•´æ€§ | â­â­â­â­â­ | â­â­â­     | æ ¸å¿ƒåŠŸèƒ½é½å…¨     |
| å­¦ä¹ æˆæœ¬   | â­â­â­     | â­â­â­â­â­ | ä»£ç ç®€æ´æ˜“æ‡‚     |
| æ‰©å±•æ€§     | â­â­â­â­â­ | â­â­â­â­   | æ¶æ„è®¾è®¡è‰¯å¥½     |

### vs ä¼ ç»Ÿ Servlet

| æ–¹é¢       | ä¼ ç»Ÿ Servlet | è‡ªç ”æ¡†æ¶ | æå‡              |
| ---------- | ------------ | -------- | ----------------- |
| ä»£ç è¡Œæ•°   | 100 è¡Œ       | 20 è¡Œ    | å‡å°‘ 80%          |
| è·¯ç”±é…ç½®   | web.xml      | æ³¨è§£     | é…ç½®å³ä»£ç         |
| å‚æ•°å¤„ç†   | æ‰‹åŠ¨         | è‡ªåŠ¨     | å¼€å‘æ•ˆç‡æå‡ 5 å€ |
| JSON å¤„ç†  | æ‰‹åŠ¨         | è‡ªåŠ¨     | å‡å°‘æ ·æ¿ä»£ç       |
| æµ‹è¯•å‹å¥½åº¦ | ä½           | é«˜       | POJO æ›´æ˜“æµ‹è¯•     |

## ğŸš§ æœ€ä½³å®è·µ

### 1. æ§åˆ¶å™¨è®¾è®¡åŸåˆ™

```java
@Controller
public class UserController {

    private final UserService userService;

    // æ„é€ å‡½æ•°æ³¨å…¥ï¼ˆè™½ç„¶æš‚ä¸æ”¯æŒï¼Œä½†ä½“ç°è®¾è®¡æ€æƒ³ï¼‰
    public UserController(UserService userService) {
        this.userService = userService;
    }

    // âœ… å¥½çš„å®è·µï¼šå•ä¸€èŒè´£
    @GetMapping("/api/users/{id}")
    @ResponseBody
    public Result<User> getUser(@PathVariable("id") Long id) {
        User user = userService.findById(id);
        return ResultBuilder.success(user);
    }

    // âŒ é¿å…ï¼šåœ¨Controllerä¸­å†™ä¸šåŠ¡é€»è¾‘
    @GetMapping("/api/users/{id}/complex")
    @ResponseBody
    public Result<User> getComplexUser(@PathVariable("id") Long id) {
        // å¤§é‡ä¸šåŠ¡é€»è¾‘...ï¼ˆåº”è¯¥æ”¾åœ¨Serviceå±‚ï¼‰
        return ResultBuilder.success(user);
    }
}
```

### 2. ç»Ÿä¸€å“åº”æ ¼å¼

```java
public class Result<T> {
    private String code;
    private String message;
    private T data;
    private Long timestamp;

    // æ„é€ å‡½æ•°ã€getterã€setter...
}

public class ResultBuilder {
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode("200");
        result.setMessage("æˆåŠŸ");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }

    public static <T> Result<T> error(String message) {
        Result<T> result = new Result<>();
        result.setCode("500");
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
}
```

### 3. å¼‚å¸¸å¤„ç†ç­–ç•¥

```java
// å…¨å±€å¼‚å¸¸å¤„ç†
@Controller
public class GlobalExceptionHandler {

    @ExceptionHandler(ValidationException.class)
    @ResponseBody
    public Result<String> handleValidation(ValidationException e) {
        return ResultBuilder.error("å‚æ•°æ ¡éªŒå¤±è´¥: " + e.getMessage());
    }

    @ExceptionHandler(BusinessException.class)
    @ResponseBody
    public Result<String> handleBusiness(BusinessException e) {
        return ResultBuilder.error(e.getMessage());
    }

    @ExceptionHandler(Exception.class)
    @ResponseBody
    public Result<String> handleGeneral(Exception e) {
        // è®°å½•æ—¥å¿—
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return ResultBuilder.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

## ğŸ¯ æœªæ¥æ‰©å±•æ–¹å‘

### 1. ä¾èµ–æ³¨å…¥æ”¯æŒ

```java
@Controller
public class UserController {

    @Autowired
    private UserService userService;

    @Autowired
    private RedisTemplate redisTemplate;
}
```

### 2. AOP åˆ‡é¢æ”¯æŒ

```java
@Aspect
public class LoggingAspect {

    @Around("@annotation(Loggable)")
    public Object logExecutionTime(ProceedingJoinPoint joinPoint) throws Throwable {
        long start = System.currentTimeMillis();
        Object result = joinPoint.proceed();
        long end = System.currentTimeMillis();

        System.out.println("Method " + joinPoint.getSignature().getName() +
                          " executed in " + (end - start) + "ms");
        return result;
    }
}
```

### 3. æ•°æ®æ ¡éªŒæ”¯æŒ

```java
public class User {
    @NotNull(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Length(min = 3, max = 20, message = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä¹‹é—´")
    private String username;

    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
    private String email;
}

@PostMapping("/api/users")
@ResponseBody
public Result<User> createUser(@RequestBody @Valid User user) {
    // è‡ªåŠ¨æ ¡éªŒï¼Œæ ¡éªŒå¤±è´¥æŠ›å‡ºValidationException
    return ResultBuilder.success(userService.create(user));
}
```

### 4. ç¼“å­˜æ”¯æŒ

```java
@GetMapping("/api/users/{id}")
@ResponseBody
@Cacheable(value = "users", key = "#id")
public Result<User> getUser(@PathVariable("id") Long id) {
    User user = userService.findById(id);
    return ResultBuilder.success(user);
}
```

## ğŸ“ æ€»ç»“

é€šè¿‡æœ¬æ–‡çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æˆåŠŸæ„å»ºäº†ä¸€ä¸ªç°ä»£åŒ–çš„ Java è·¯ç”±æ¡†æ¶ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### ğŸ‰ æŠ€æœ¯æˆå°±

- **æ³¨è§£é©±åŠ¨å¼€å‘**ï¼šå‘Šåˆ« XML é…ç½®ï¼Œæ‹¥æŠ±æ³¨è§£
- **é«˜æ€§èƒ½è·¯ç”±**ï¼šTrie æ ‘ç®—æ³•ï¼ŒO(n)æ—¶é—´å¤æ‚åº¦
- **è‡ªåŠ¨å‚æ•°ç»‘å®š**ï¼šå‡å°‘ 90%æ ·æ¿ä»£ç 
- **å†…å®¹åå•†**ï¼šè‡ªåŠ¨ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- **æ‹¦æˆªå™¨æœºåˆ¶**ï¼šAOP æ€æƒ³çš„ä½“ç°
- **æ‰©å±•æ€§è®¾è®¡**ï¼šç­–ç•¥æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼çš„åº”ç”¨

### ğŸš€ å®ç”¨ä»·å€¼

- **å¼€å‘æ•ˆç‡**ï¼šç›¸æ¯”ä¼ ç»Ÿ Servlet æå‡ 5 å€å¼€å‘æ•ˆç‡
- **ä»£ç è´¨é‡**ï¼šPOJO Controller æ›´æ˜“æµ‹è¯•å’Œç»´æŠ¤
- **å­¦ä¹ ä»·å€¼**ï¼šæ·±å…¥ç†è§£ Spring MVC åº•å±‚åŸç†
- **é¡¹ç›®å®æˆ˜**ï¼šå¯ç›´æ¥åº”ç”¨äºä¸­å°å‹é¡¹ç›®

### ğŸ“ å­¦ä¹ æ”¶è·

- **è®¾è®¡æ¨¡å¼åº”ç”¨**ï¼šç­–ç•¥ã€å·¥å‚ã€æ¨¡æ¿æ–¹æ³•ã€è´£ä»»é“¾
- **åå°„æœºåˆ¶**ï¼šæ³¨è§£å¤„ç†ã€åŠ¨æ€è°ƒç”¨
- **ç®—æ³•æ€ç»´**ï¼šTrie æ ‘åœ¨è·¯ç”±åŒ¹é…ä¸­çš„åº”ç”¨
- **æ¶æ„æ€ç»´**ï¼šåˆ†å±‚è®¾è®¡ã€èŒè´£åˆ†ç¦»

è¿™ä¸ªè·¯ç”±æ¡†æ¶è™½ç„¶ç›¸æ¯” Spring MVC åŠŸèƒ½ç›¸å¯¹ç®€å•ï¼Œä½†éº»é›€è™½å°ï¼Œäº”è„ä¿±å…¨ã€‚é€šè¿‡è‡ªå·±åŠ¨æ‰‹å®ç°ï¼Œæˆ‘ä»¬ä¸ä»…æ·±å…¥ç†è§£äº†ç°ä»£ Web æ¡†æ¶çš„å·¥ä½œåŸç†ï¼Œæ›´é‡è¦çš„æ˜¯åŸ¹å…»äº†æ¶æ„æ€ç»´å’Œä»£ç è®¾è®¡èƒ½åŠ›ã€‚

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚è¿›ä¸€æ­¥æ‰©å±•åŠŸèƒ½ï¼Œæ¯”å¦‚æ·»åŠ ä¾èµ–æ³¨å…¥ã€AOP åˆ‡é¢ã€æ•°æ®æ ¡éªŒç­‰ç‰¹æ€§ï¼Œé€æ­¥æ„å»ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ä¼ä¸šçº§æ¡†æ¶ã€‚

> ğŸ’¡ **ç¼–ç¨‹æ„Ÿæ‚Ÿ**ï¼šæ¡†æ¶çš„æœ¬è´¨æ˜¯å¯¹é€šç”¨æ¨¡å¼çš„æŠ½è±¡å’Œå°è£…ã€‚å½“æˆ‘ä»¬ç†è§£äº†è¿™äº›æ¨¡å¼èƒŒåçš„è®¾è®¡æ€æƒ³ï¼Œå°±èƒ½ä¸¾ä¸€åä¸‰ï¼Œè®¾è®¡å‡ºæ›´ä¼˜é›…ã€æ›´é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚

---

**å‚è€ƒèµ„æº**ï¼š

- [Spring MVC å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-framework/docs/current/reference/html/web.html)
- [Java Servlet è§„èŒƒ](https://javaee.github.io/servlet-spec/)
- [è®¾è®¡æ¨¡å¼åœ¨ Web æ¡†æ¶ä¸­çš„åº”ç”¨](https://refactoring.guru/design-patterns)

**å®Œæ•´æºç **ï¼š[GitHub ä»“åº“åœ°å€] (åŒ…å«æ‰€æœ‰ç¤ºä¾‹ä»£ç å’Œæµ‹è¯•ç”¨ä¾‹)
